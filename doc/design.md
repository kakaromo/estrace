# ESTrace 시스템 설계 문서

## 1. 개요

ESTrace는 Android Block I/O 및 UFS(Universal Flash Storage) 성능 분석을 위한 데스크톱 애플리케이션입니다. 이 문서는 시스템의 전체적인 설계와 아키텍처를 상세히 설명합니다.

### 1.1 프로젝트 목표
- Android 디바이스의 I/O 성능 트레이스 수집 및 분석
- 실시간 성능 모니터링 및 시각화
- 트레이스 패턴 관리 및 테스트
- 데이터 내보내기 및 공유 기능

### 1.2 핵심 기능
- Block I/O 트레이스 수집 및 분석
- UFS 성능 트레이스 수집 및 분석
- 지연 시간(Latency) 통계 분석
- 읽기/쓰기 패턴 분석
- 크기별 성능 분석
- 스캐터 차트 및 히트맵 시각화
- 트레이스 패턴 관리
- 데이터 내보내기 (Parquet, CSV)

## 2. 시스템 아키텍처

### 2.1 전체 아키텍처

```
┌─────────────────────────────────────────────────────────────┐
│                    사용자 인터페이스 계층                      │
│  ┌─────────────────┐  ┌─────────────────┐  ┌───────────────┐ │
│  │     메인 뷰     │  │    디테일 뷰    │  │    설정 뷰    │ │
│  │  (트레이스 목록) │  │   (분석 결과)   │  │ (패턴 관리)   │ │
│  └─────────────────┘  └─────────────────┘  └───────────────┘ │
└─────────────────────────────────────────────────────────────┘
                               │
                        SvelteKit Frontend
                               │
┌─────────────────────────────────────────────────────────────┐
│                     비즈니스 로직 계층                        │
│  ┌─────────────────┐  ┌─────────────────┐  ┌───────────────┐ │
│  │   Trace 관리    │  │   데이터 분석   │  │  패턴 관리    │ │
│  │                 │  │                 │  │               │ │
│  └─────────────────┘  └─────────────────┘  └───────────────┘ │
└─────────────────────────────────────────────────────────────┘
                               │
                         Tauri Bridge
                               │
┌─────────────────────────────────────────────────────────────┐
│                     데이터 처리 계층                          │
│  ┌─────────────────┐  ┌─────────────────┐  ┌───────────────┐ │
│  │  파일 파싱      │  │   데이터 변환   │  │  캐시 관리    │ │
│  │  (Regex 기반)   │  │  (Apache Arrow) │  │  (Memory)     │ │
│  └─────────────────┘  └─────────────────┘  └───────────────┘ │
└─────────────────────────────────────────────────────────────┘
                               │
                          Rust Backend
                               │
┌─────────────────────────────────────────────────────────────┐
│                      데이터 저장 계층                         │
│  ┌─────────────────┐  ┌─────────────────┐  ┌───────────────┐ │
│  │     SQLite      │  │   파일 시스템   │  │  설정 관리    │ │
│  │  (메타데이터)   │  │  (트레이스 데이터)│  │  (패턴, 설정) │ │
│  └─────────────────┘  └─────────────────┘  └───────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 아키텍처 특징

#### 2.2.1 하이브리드 아키텍처
- **Frontend**: SvelteKit + TypeScript
- **Backend**: Rust + Tauri
- **Database**: SQLite (메타데이터 저장)
- **Data Processing**: Apache Arrow (고성능 데이터 처리)

#### 2.2.2 데이터 플로우
1. **수집**: 외부 트레이스 파일 로드
2. **파싱**: Rust 정규표현식 엔진으로 로그 파싱
3. **캐싱**: 메모리 캐시를 통한 빠른 접근
4. **분석**: 통계 분석 및 집계
5. **시각화**: ECharts/Plotly.js를 통한 시각화
6. **저장**: SQLite를 통한 메타데이터 영속화

## 3. 모듈 설계

### 3.1 Frontend 모듈 구조

```
src/
├── routes/                 # SvelteKit 라우팅
│   ├── +page.svelte       # 메인 페이지
│   ├── +layout.svelte     # 공통 레이아웃
│   └── detail/            # 디테일 페이지
├── components/            # 재사용 가능한 컴포넌트
│   ├── trace.svelte       # 트레이스 메인 컴포넌트
│   ├── appmenu.svelte     # 애플리케이션 메뉴
│   ├── detail/            # 분석 화면 컴포넌트
│   │   ├── CPUTabs.svelte         # CPU 분석 탭
│   │   ├── LatencyTabs.svelte     # 지연시간 분석 탭
│   │   ├── scattercharts.svelte   # 스캐터 차트
│   │   └── ...
│   ├── menu/              # 메뉴 관련 컴포넌트
│   └── table/             # 테이블 컴포넌트
├── stores/                # Svelte 전역 상태 관리
│   ├── trace.ts           # 트레이스 데이터 상태
│   ├── setting.ts         # 설정 상태
│   └── file.ts            # 파일 상태
├── api/                   # API 통신 모듈
│   ├── db.ts              # 데이터베이스 API
│   └── pattern.ts         # 패턴 관리 API
└── utils/                 # 유틸리티 함수
    ├── compression.ts     # 데이터 압축
    └── trace-helper.ts    # 트레이스 헬퍼
```

### 3.2 Backend 모듈 구조

```
src-tauri/src/
├── lib.rs                 # 라이브러리 진입점
├── main.rs                # 애플리케이션 진입점
└── trace/                 # 트레이스 처리 모듈
    ├── mod.rs             # 모듈 정의 및 공통 기능
    ├── types.rs           # 데이터 타입 정의
    ├── block.rs           # Block I/O 트레이스 처리
    ├── ufs.rs             # UFS 트레이스 처리
    ├── patterns.rs        # 패턴 관리
    ├── filter.rs          # 데이터 필터링
    ├── export.rs          # 데이터 내보내기
    └── utils.rs           # 유틸리티 함수
```

### 3.3 핵심 데이터 구조

#### 3.3.1 Block I/O 트레이스
```rust
pub struct Block {
    pub command: String,        // 명령 타입 (R/W)
    pub pid: i32,              // 프로세스 ID
    pub timestamp: f64,        // 타임스탬프
    pub device_id: String,     // 디바이스 ID
    pub start_lba: u64,        // 시작 LBA
    pub num_sectors: u32,      // 섹터 수
    pub latency: f64,          // 지연 시간
    pub size: u64,             // 데이터 크기
    pub queue_depth: u32,      // 큐 깊이
    pub completion_time: f64,  // 완료 시간
}
```

#### 3.3.2 UFS 트레이스
```rust
pub struct UFS {
    pub command: String,       // UFS 명령
    pub tag: u32,             // 명령 태그
    pub timestamp: f64,       // 타임스탬프
    pub size: i32,            // 전송 크기
    pub lba: u64,             // 논리 블록 주소
    pub opcode: String,       // 오퍼레이션 코드
    pub group_id: String,     // 그룹 ID
    pub latency: f64,         // 지연 시간
    pub hwq_id: i32,          // 하드웨어 큐 ID
}
```

## 4. 데이터 플로우 설계

### 4.1 트레이스 수집 플로우

```
파일 선택 → 로그 파싱 → 데이터 검증 → 캐시 저장 → 분석 준비
    ↓
SQLite 메타데이터 저장 → UI 업데이트 → 사용자 피드백
```

### 4.2 데이터 분석 플로우

```
캐시된 데이터 → 필터 적용 → 통계 계산 → 시각화 데이터 생성
    ↓
Apache Arrow 변환 → Frontend 전송 → 차트 렌더링
```

### 4.3 패턴 관리 플로우

```
패턴 정의 → 정규표현식 컴파일 → 검증 → SQLite 저장
    ↓
Rust 백엔드 동기화 → 활성 패턴 설정 → 파싱 엔진 업데이트
```

## 5. 성능 설계

### 5.1 메모리 관리
- **캐시 전략**: LRU 기반 메모리 캐시
- **데이터 압축**: zstd 압축 알고리즘 사용
- **지연 로딩**: 필요시에만 데이터 로드

### 5.2 병렬 처리
- **Rayon**: Rust 병렬 처리 라이브러리
- **Worker Thread**: 백그라운드 작업 처리
- **Streaming**: 대용량 파일 스트리밍 처리

### 5.3 최적화 기법
- **Apache Arrow**: 컬럼형 메모리 포맷
- **메모리 매핑**: 대용량 파일 효율적 접근
- **배치 처리**: 대량 데이터 일괄 처리

## 6. 보안 설계

### 6.1 데이터 보호
- **로컬 저장**: 모든 데이터 로컬 저장
- **암호화**: 민감한 설정 정보 암호화
- **권한 관리**: 파일 시스템 접근 권한 최소화

### 6.2 입력 검증
- **파일 검증**: 트레이스 파일 형식 검증
- **정규표현식 검증**: 패턴 안전성 검증
- **SQL 인젝션 방지**: 매개변수화된 쿼리 사용

## 7. 확장성 설계

### 7.1 모듈 확장
- **플러그인 아키텍처**: 새로운 트레이스 타입 추가 가능
- **패턴 시스템**: 사용자 정의 파싱 패턴 지원
- **내보내기 형식**: 새로운 내보내기 형식 추가 가능

### 7.2 플랫폼 지원
- **크로스 플랫폼**: Windows, macOS, Linux 지원
- **네이티브 성능**: Rust 백엔드를 통한 고성능
- **웹 기술**: 모던 웹 기술 스택 활용

## 8. 품질 보증

### 8.1 테스트 전략
- **단위 테스트**: Rust 모듈 단위 테스트
- **통합 테스트**: Frontend-Backend 통합 테스트
- **성능 테스트**: 대용량 데이터 처리 성능 테스트

### 8.2 모니터링
- **로깅**: 구조화된 로그 시스템
- **오류 처리**: 포괄적인 오류 처리 및 복구
- **사용자 피드백**: 진행 상황 및 오류 알림

이 설계 문서는 ESTrace 시스템의 전체적인 구조와 설계 철학을 제공하며, 각 모듈의 역할과 상호작용을 명확히 정의합니다.